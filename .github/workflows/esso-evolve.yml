name: ESSO Evolver (MPRD Examples)

on:
  pull_request:
    paths:
      - internal/tools/evolver/examples/mprd/**
  push:
    branches:
      - main
    paths:
      - internal/tools/evolver/examples/mprd/**

permissions:
  contents: read
  pull-requests: write

jobs:
  evolve:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install z3-solver PyYAML

      - name: Detect changed models
        id: changed
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${GITHUB_EVENT_NAME}" == "pull_request" ]]; then
            base="${{ github.event.pull_request.base.sha }}"
            head="${{ github.sha }}"
          else
            base="${{ github.event.before }}"
            head="${{ github.sha }}"
          fi

          git diff --name-only "${base}" "${head}" -- 'internal/tools/evolver/examples/mprd/*.yaml' > changed_models.txt || true

          if [[ ! -s changed_models.txt ]]; then
            echo "found=false" >> "${GITHUB_OUTPUT}"
            exit 0
          fi

          echo "found=true" >> "${GITHUB_OUTPUT}"
          echo "Changed models:"
          cat changed_models.txt

      - name: Run evolver
        if: steps.changed.outputs.found == 'true'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p esso_evolve_runs

          while IFS= read -r model; do
            base="$(basename "${model}")"
            out="esso_evolve_runs/${base%.yaml}"
            mkdir -p "${out}"
            python -m internal.tools.evolver evolve "${model}" \
              --generations 15 \
              --population 20 \
              --timeout-ms 15000 \
              --output "${out}" \
              --save-svg \
              --pretty > "${out}/stdout.json"
          done < changed_models.txt

      - name: Summarize improvements
        if: steps.changed.outputs.found == 'true'
        id: summary
        shell: bash
        run: |
          set -euo pipefail
          python - <<'PY'
          from __future__ import annotations

          import json
          import os
          from pathlib import Path

          from internal.tools.evolver.ir.schema import CandidateIR
          from internal.tools.evolver.verify.fitness import log2_upper_bound

          root = Path("esso_evolve_runs")
          improved = []
          for d in sorted(p for p in root.iterdir() if p.is_dir()):
            summary_path = d / "summary.json"
            if not summary_path.exists():
              continue
            s = json.loads(summary_path.read_text())
            best = s.get("best")
            if best is None:
              continue
            ref_hash = s["model"]["ir_hash"]
            best_hash = best["hash"]
            if best_hash == ref_hash:
              continue

            ref_ir = CandidateIR.from_json((d / "reference.json").read_text())
            base_lb = log2_upper_bound(ref_ir)
            best_lb = float(best["fitness"]["log2_upper_bound"])
            improved.append((s["model"]["path"], base_lb, best_lb, d))

          md_lines = []
          if improved:
            md_lines.append("ESSO evolver found improvements:")
            md_lines.append("")
            md_lines.append("| Model | ref log2_upper_bound | best log2_upper_bound | Î” | Artifacts |")
            md_lines.append("|---|---:|---:|---:|---|")
            for model, base_lb, best_lb, d in improved:
              md_lines.append(
                f"| `{model}` | {base_lb:.3f} | {best_lb:.3f} | {(best_lb - base_lb):.3f} | `{d}` |"
              )
          else:
            md_lines.append("ESSO evolver found no improvements for the changed models.")

          out = "\n".join(md_lines) + "\n"
          Path("esso_evolve_runs/summary.md").write_text(out)
          print(out)

          # Write a job summary.
          Path(os.environ["GITHUB_STEP_SUMMARY"]).write_text(out)

          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as f:
            f.write(f"improved={'true' if improved else 'false'}\n")
          PY

      - name: Upload evolver artifacts
        if: steps.changed.outputs.found == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: esso-evolve-runs
          path: esso_evolve_runs/

      - name: Comment on PR (improvements)
        if: github.event_name == 'pull_request' && steps.changed.outputs.found == 'true' && steps.summary.outputs.improved == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");
            const body = fs.readFileSync("esso_evolve_runs/summary.md", "utf8");
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body,
            });
